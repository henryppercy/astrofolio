---
import countries from "../json/countries.json";

const visited = [
  "Ireland",
  "France",
  "Germany",
  "Spain",
  "Belgium",
  "Netherlands",
  "Denmark",
  "Poland",
  "Bulgaria",

  "Singapore",
  "Malaysia",
  "Laos",
  "Thailand",
  "Vietnam",
  "Cambodia",
  "Taiwan",
  "Philippines",

  "USA",

  "South Africa",
  "Swaziland",
];

const homeCountry = countries.features.filter(
  (c) => c.properties.name == "England"
);
const visitedCountries = countries.features.filter((c) =>
  visited.includes(c.properties.name)
);
const nonVisitedCountries = countries.features.filter(
  (c) => !visited.includes(c.properties.name) && c.properties.name !== "England"
);
---

<div id="map" class="w-full flex items-center justify-center"></div>

<script type="module" define:vars={{ visitedCountries, nonVisitedCountries, homeCountry }}>
  import * as d3 from "https://cdn.jsdelivr.net/npm/d3@4/+esm";
  
  let width = d3.select("#map").node().getBoundingClientRect().width;
  let height = 500;
  const sensitivity = 75;

  let projection = d3
    .geoOrthographic()
    .scale(250)
    .center([0, 0])
    .rotate([0, -30])
    .translate([width / 2, height / 2]);

  const initialScale = projection.scale();
  let path = d3.geoPath().projection(projection);

  let svg = d3
    .select("#map")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  let globe = svg
    .append("circle")
    .attr("fill", "url(#globeGradient)")
    .attr("stroke", "#d6d3d1") // stone-300
    .attr("stroke-width", "0.4")
    .attr("cx", width / 2)
    .attr("cy", height / 2)
    .attr("r", initialScale);

  svg
    .call(
      d3.drag().on("drag", () => {
        const rotate = projection.rotate();
        const k = sensitivity / projection.scale();
        projection.rotate([
          rotate[0] + d3.event.dx * k,
          rotate[1] - d3.event.dy * k,
        ]);
        path = d3.geoPath().projection(projection);
        svg.selectAll("path").attr("d", path);
      })
    )
    .call(
      d3.zoom().on("zoom", () => {
        if (d3.event.transform.k > 0.3) {
          projection.scale(initialScale * d3.event.transform.k);
          path = d3.geoPath().projection(projection);
          svg.selectAll("path").attr("d", path);
          globe.attr("r", projection.scale());
        } else {
          d3.event.transform.k = 0.3;
        }
      })
    );

  let map = svg.append("g");

  let graticule = d3.geoGraticule();

	map
    .append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path)
    .attr("fill", "none")
    .attr("stroke", "#e7e5e4") // stone-200
    .attr("stroke-width", 0.5)
    .attr("opacity", 0.1);

  map
    .append("g")
    .attr("class", "countries")
    .selectAll("path")
    .data(homeCountry)
    .enter()
    .append("path")
    .attr("class", (d) => "country_" + d.properties.name.replace(" ", "_"))
    .attr("d", path)
    .attr("fill", "#0c0a09") // stone-700 (or even use blue-950 if semantic)
    .style("stroke", "#a8a29e") // stone-300
    .style("stroke-width", 0.5)
    .style("opacity", 0.7);

  map
    .append("g")
    .attr("class", "countries")
    .selectAll("path")
    .data(nonVisitedCountries)
    .enter()
    .append("path")
    .attr("class", (d) => "country_" + d.properties.name.replace(" ", "_"))
    .attr("d", path)
    .attr("fill", "#d6d3d1") // stone-300
	  .style("stroke", "#a8a29e") // stone-400
    .style("stroke-width", 0.3)
	  .style("opacity", 0.7);

  map
    .append("g")
    .attr("class", "countries")
    .selectAll("path")
    .data(visitedCountries)
    .enter()
    .append("path")
    .attr("class", (d) => "country_" + d.properties.name.replace(" ", "_"))
    .attr("d", path)
    .attr("fill", "#57534e") // stone-600
    .style("stroke", "#fefdfb") // stone-900
    .style("stroke-width", 0.5)
    .style("opacity", 0.7);

	let defs = svg.append("defs");

	let radialGradient = defs
		.append("radialGradient")
		.attr("id", "globeGradient")
		.attr("cx", "50%")
		.attr("cy", "50%");

	radialGradient
		.append("stop")
		.attr("offset", "0%")
		.attr("stop-color", "#a8a29e"); // stone-100

	radialGradient
		.append("stop")
		.attr("offset", "100%")
		.attr("stop-color", "#292524"); // stone-400

  d3.timer(function(elapsed) {
    const rotate = projection.rotate()
    const k = sensitivity / projection.scale()
    projection.rotate([
      rotate[0] - 0.3 * k,
      rotate[1]
    ])
    path = d3.geoPath().projection(projection)
    svg.selectAll("path").attr("d", path)
  }, 200)
</script>
