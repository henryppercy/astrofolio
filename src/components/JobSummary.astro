---
import { getCollection } from "astro:content";

const jobs = await getCollection('job');

const formattedJobs = jobs.map(job => ({
    ...job,
    data: {
        ...job.data,
        start_date: new Date(job.data.start_date),
        finish_date: job.data.finish_date ? new Date(job.data.finish_date) : null,
    }
}));
---
<div class="space-y-3">
    {formattedJobs
        .sort((a, b) => new Date(b.data.start_date).getTime() - new Date(a.data.start_date).getTime())
        .map(job => (
            <details>
                <summary class="group flex cursor-pointer items-baseline space-x-4">
                    <span class="flex-none font-medium group-hover:text-stone-900 group-hover:dark:text-stone-50 transition-colors">
                        {job.data.company_short ? (
                            <>
                                <span class="hidden md:block">{job.data.company}</span>
                                <span class="hidden max-md:block">{job.data.company_short}</span>
                            </>
                        ) : (
                            <>
                                {job.data.company}
                            </>
                        )}
                    </span>
                    <span class="w-full flex-shrink border-t border-dashed border-neutral-300 dark:border-neutral-700"></span>
                    <span class="flex-none">
                        {job.data.job_titles[0]}
                    </span>
                    <span class="flex-none font-mono text-xs tabular-nums">
                        {job.data.start_date.getFullYear() === job.data.finish_date?.getFullYear() ? (
                            <>
                                <time datetime={String(job.data.start_date)}>{job.data.start_date.toLocaleDateString('en-US', { year: 'numeric' })}</time><span>&nbsp;&nbsp;&nbsp;</span>
                            </>
                        ) : (
                            <>
                                <time datetime={String(job.data.start_date)}>{job.data.start_date.toLocaleDateString('en-US', { year: 'numeric' })}</time>-{job.data.finish_date ? (<time datetime={String(job.data.finish_date)}>{(job.data.finish_date).toLocaleDateString('en-US', { year: '2-digit' })}</time>) : (<span>&nbsp;&nbsp;</span>)}
                            </>
                        )}
                    </span>
                </summary>
                <p class="mb-8 max-w-4xl prose prose-stone dark:prose-invert text-sm">{job.data.summary}</p>
            </details>
        )
    )}
</div>